name: CI/CD Pipeline

on:
  push:
    branches:
      - main

env:
  DOCKER_IMAGE: fastapi-app
  DOCKER_TAG: ${{ github.sha }}

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v3
    
    - name: Login to Docker Hub
      uses: docker/login-action@v3
      with:
        username: ${{ secrets.DOCKERHUB_USERNAME }}
        password: ${{ secrets.DOCKERHUB_TOKEN }}
    
    - name: Build Docker image
      uses: docker/build-push-action@v5
      with:
        context: .
        push: true
        tags: |
          ${{ secrets.DOCKERHUB_USERNAME }}/${{ env.DOCKER_IMAGE }}:${{ env.DOCKER_TAG }}
          ${{ secrets.DOCKERHUB_USERNAME }}/${{ env.DOCKER_IMAGE }}:latest
        cache-from: type=registry,ref=${{ secrets.DOCKERHUB_USERNAME }}/${{ env.DOCKER_IMAGE }}:buildcache
        cache-to: type=registry,ref=${{ secrets.DOCKERHUB_USERNAME }}/${{ env.DOCKER_IMAGE }}:buildcache,mode=max
    
    - name: Setup SSH
      uses: webfactory/ssh-agent@v0.9.0
      with:
        ssh-private-key: ${{ secrets.BASTION_SSH_KEY }}
    
    - name: Add bastion to known hosts
      run: |
        ssh-keyscan -H ${{ secrets.BASTION_HOST }} >> ~/.ssh/known_hosts
    
    - name: Deploy to Kubernetes
      env:
        BASTION_HOST: ${{ secrets.BASTION_HOST }}
        BASTION_USER: civo
        KUBECONFIG_PATH: ~/.kube/config
        DOCKER_IMAGE_FULL: ${{ secrets.DOCKERHUB_USERNAME }}/${{ env.DOCKER_IMAGE }}:${{ env.DOCKER_TAG }}
      run: |
        # Create temporary directory for manifests
        mkdir -p /tmp/k8s-manifests
        
        # Copy manifests
        cp k8s/*.yaml /tmp/k8s-manifests/
        
        # Update deployment image
        sed -i "s|YOUR_DOCKERHUB_USERNAME/fastapi-app:latest|${DOCKER_IMAGE_FULL}|g" /tmp/k8s-manifests/deployment.yaml
        
        # Transfer manifests to bastion
        scp -r /tmp/k8s-manifests ${BASTION_USER}@${BASTION_HOST}:/tmp/
        
        # Apply manifests via bastion
        ssh ${BASTION_USER}@${BASTION_HOST} << 'ENDSSH'
          export KUBECONFIG=~/.kube/config
          kubectl create namespace fastapi --dry-run=client -o yaml | kubectl apply -f -
          kubectl apply -f /tmp/k8s-manifests/
          kubectl rollout status deployment/fastapi-app -n fastapi --timeout=5m
          rm -rf /tmp/k8s-manifests
        ENDSSH
    
    - name: Verify deployment
      env:
        BASTION_HOST: ${{ secrets.BASTION_HOST }}
        BASTION_USER: civo
      run: |
        ssh ${BASTION_USER}@${BASTION_HOST} << 'ENDSSH'
          export KUBECONFIG=~/.kube/config
          echo "=== Pods ==="
          kubectl get pods -l app=fastapi-app -n fastapi
          echo ""
          echo "=== Service ==="
          kubectl get svc fastapi-app -n fastapi
          echo ""
          echo "=== Ingress ==="
          kubectl get ingress -n fastapi || echo "Ingress not found (may need domain configuration)"
          echo ""
          echo "=== Deployment Status ==="
          kubectl get deployment fastapi-app -n fastapi
        ENDSSH

